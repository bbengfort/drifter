#!/usr/bin/env python
# drifter
# Executable script to run drifter commands
#
# Author:   Benjamin Bengfort <benjamin@bengfort.com>
# Created:  Tue Jun 10 10:03:47 2014 -0400
#
# Copyright (C) 2014 Bengfort.com
# For license information, see LICENSE.txt
#
# ID: drifter [] benjamin@bengfort.com $

"""
Executable script to run drifter commands
"""

##########################################################################
## Imports
##########################################################################

import sys
import drifter
import argparse
import traceback

from drifter.chart import chart_times

##########################################################################
## Module Constants
##########################################################################

VERSION     = "1.0"
DESCRIPTION = "Run drifter commands against the Phoenix-API"
EPILOG      = "This software is for internal test use only."

##########################################################################
## Functional commands
##########################################################################

def show_config(args):
    return str(drifter.settings)

def runner(args):
    runner = drifter.Runner(args.runs)
    times, time = runner.categories_runner(debug=True)
    chart_times(times, title='Categories Endpoint Times')
    return "Runner took %0.3f seconds to execute %i runs" % (time, args.runs)

##########################################################################
## Main Method and functionality
##########################################################################

def main(*argv):
    """
    Handles command line input and executes functionality.
    """

    # The parent parser includes the traceback flag
    pyparser   = argparse.ArgumentParser(add_help=False)
    pyparser.add_argument('--traceback', action='store_true', default=False, help='On error, show the Python traceback')

    # Setup the main parser and subparsers
    parser     = argparse.ArgumentParser(version=VERSION, description=DESCRIPTION, epilog=EPILOG)
    subparsers = parser.add_subparsers(title='commands', description='Administrative commands for Drifter')

    # Show config command
    conf_parser = subparsers.add_parser('config', help='Show the current configuration of Drifter', parents=[pyparser])
    conf_parser.set_defaults(func=show_config)

    # Runner command
    runner_parser = subparsers.add_parser('run', help='Run a command on the specified endpoints', parents=[pyparser])
    runner_parser.add_argument('-n', default=100, dest='runs', type=int, help='Number of runs to execute the runner on')
    runner_parser.set_defaults(func=runner)

    # Handle input from the command line
    args = parser.parse_args()            # Parse the arguments
    try:
        msg = "%s\n" % args.func(args)    # Call the default function
        parser.exit(0, msg)               # Exit clearnly with message
    except Exception as e:
        if hasattr(args, 'traceback') and args.traceback:
            traceback.print_exc()
        parser.error(str(e))              # Exit with error

if __name__ == '__main__':
    main(*sys.argv)
