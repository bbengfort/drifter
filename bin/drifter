#!/usr/bin/env python
# drifter
# Executable script to run drifter commands
#
# Author:   Benjamin Bengfort <benjamin@bengfort.com>
# Created:  Tue Jun 10 10:03:47 2014 -0400
#
# Copyright (C) 2014 Bengfort.com
# For license information, see LICENSE.txt
#
# ID: drifter [] benjamin@bengfort.com $

"""
Executable script to run drifter commands
"""

##########################################################################
## Imports
##########################################################################

import sys
import drifter
import argparse
import traceback

##########################################################################
## Module Constants
##########################################################################

VERSION     = "1.0"
DESCRIPTION = "Run drifter commands against the Phoenix-API"
EPILOG      = "This software is for internal test use only."

VERBS       = ('GET', 'POST', 'PUT', 'DELETE', 'PATCH', 'OPTIONS')
ENDPOINTS   = ('categories', 'brands', 'sizes')

##########################################################################
## Functional commands
##########################################################################

def show_config(args):
    return str(drifter.settings)

def runner(args):
    print ("Executing drifter on the following endpoints:\n"
           "    GET /%s\n"
           "    GET /%s\n"
           "    GET /%s\n") % ENDPOINTS

    runner = drifter.Runner(args.runs, wait=args.wait)
    times  = []
    for endpoint in ENDPOINTS:
        action = runner.get_runner(endpoint)
        if action is None:
            raise Exception("Could not find runner for endpoint '%s'" % endpoint)
        _, time = action()
        times.append(time)

    print "\nDrifter complete!"

    if args.outfile: runner.dump(args.outfile)

    for label, stats in runner.statistics().items():
        print "Statistics for the %s runner:" % label
        for stat, val in stats.items():
            print "    %s: %0.3f" % (stat.title(), val)

    runner.display()
    return "Runner took %0.3f seconds to execute %i runs" % (sum(times), args.runs*len(ENDPOINTS))

def endpoints(args):
    tests = "\n".join(("    %s /%s" % (args.method, ep) for ep in args.endpoint))
    print "Executing drifter on the following endpoints:\n%s" % tests

    runner = drifter.Runner(args.runs, wait=args.wait)
    times  = []
    for idx, endpoint in enumerate(args.endpoint):
        action = runner.get_runner(endpoint)
        if action is None:
            raise Exception("Could not find runner for endpoint '%s'" % endpoint)
        _, time = action(label="%s /%s %i" % (args.method, endpoint, idx))
        times.append(time)

    print "\nDrifter complete!"

    if args.outfile: runner.dump(args.outfile)

    for label, stats in runner.statistics().items():
        print "Statistics for the %s runner:" % label
        for stat, val in stats.items():
            print "    %s: %0.3f" % (stat.title(), val)

    runner.display()
    return "Runner took %0.3f seconds to execute %i runs" % (sum(times), args.runs*len(args.endpoint))

##########################################################################
## Main Method and functionality
##########################################################################

def main(*argv):
    """
    Handles command line input and executes functionality.
    """

    # The parent parser includes the traceback flag
    pyparser   = argparse.ArgumentParser(add_help=False)
    pyparser.add_argument('--traceback', action='store_true', default=False, help='On error, show the Python traceback')
    pyparser.add_argument('-n', default=100, dest='runs', type=int, help='Number of runs to execute the runner on')
    pyparser.add_argument('-w', '--wait', default=None, type=float, help='Wait in seconds between each query.')
    pyparser.add_argument('-o', '--outfile', default=None, type=argparse.FileType('w'), help='Dump results data to a file.')

    # Setup the main parser and subparsers
    parser     = argparse.ArgumentParser(version=VERSION, description=DESCRIPTION, epilog=EPILOG)
    subparsers = parser.add_subparsers(title='commands', description='Administrative commands for Drifter')

    # Show config command
    conf_parser = subparsers.add_parser('config', help='Show the current configuration of Drifter', parents=[pyparser])
    conf_parser.set_defaults(func=show_config)

    # Runner command
    runner_parser = subparsers.add_parser('run', help='Run load testing on all known endpoints', parents=[pyparser])
    runner_parser.set_defaults(func=runner)

    # Endpoint Tester
    endpoint_parser = subparsers.add_parser('test', help='Run the tester against a specific endpoint', parents=[pyparser])
    endpoint_parser.add_argument('-m', '--method', default='GET', type=str, choices=VERBS, help='Specify the HTTP method GET/POST etc.')
    endpoint_parser.add_argument('endpoint', type=str, choices=ENDPOINTS, nargs='+', help='Specify the endpoint to test.')
    endpoint_parser.set_defaults(func=endpoints)

    # Handle input from the command line
    args = parser.parse_args()            # Parse the arguments
    try:
        msg = "%s\n" % args.func(args)    # Call the default function
        parser.exit(0, msg)               # Exit clearnly with message
    except Exception as e:
        if hasattr(args, 'traceback') and args.traceback:
            traceback.print_exc()
        parser.error(str(e))              # Exit with error

if __name__ == '__main__':
    main(*sys.argv)
